@using Microsoft.AspNet.Identity
@model VTIntranet.Models.NewModelHelper

@{
    ViewBag.Title = "Home Page";

}
<head>
    <!--DatePicker-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/css/bootstrap-datetimepicker.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.2/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/js/bootstrap-datetimepicker.min.js"></script>
    <style>
        .grid-container {
            display: grid;
            grid-template-columns: auto auto;
            padding: 10px;
        }

        #calendar {
            max-width: 600px;
            margin: 0 auto;
            height: 100%;
        }

        #hover-effect:hover:before {
            color: #122143;
        }

        .fc-scroller.fc-day-grid-container {
            height: auto !important;
        }

        .navbar-fixed-top, .navbar-fixed-bottom {
            /* z-index: 9999; */
            background: #fff !important;
        }

        #gallery {
            background: transparent;
            height: auto;
            max-height: 150px;
            overflow: hidden
        }

            #gallery a {
                color: #000 !important;
            }

        .navbar-brand {
            width: 100%
        }

        .modal-footer{
            padding: inherit !important;
        }

        .modal-content {
            height: 580px !important; 
        }

        .modal-details {
         
            position: fixed;
            background-color: white;
            width: 100%;
        
        }

        #add-dates {
           display: flex;
    justify-content: space-between;
    width: 90%;
    margin: 0 auto;
        }
        #add-dates h4 b{font-size:30px; text-transform:uppercase;color:#21356a}
        .carrusel {
            position: relative;
            box-shadow: 0px 1px 6px rgba(0, 0, 0, 0.64);
            margin-top: 26px;
        }

        .carrusel-inner {
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        .carrusel-open:checked + .carrusel-item {
            position: static;
            opacity: 100;
        }

        .carrusel-item {
            position: absolute;
            opacity: 0;
            -webkit-transition: opacity 0.6s ease-out;
            transition: opacity 0.6s ease-out;
        }

            .carrusel-item img {
                display: block;
                height: auto;
                max-width: 100%;
            }

        .carrusel-control {
            background: rgba(0, 0, 0, 0.28);
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            display: none;
            font-size: 40px;
            height: 40px;
            line-height: 35px;
            position: absolute;
            top: 50%;
            -webkit-transform: translate(0, -50%);
            cursor: pointer;
            -ms-transform: translate(0, -50%);
            transform: translate(0, -50%);
            text-align: center;
            width: 40px;
            z-index: 10;
        }

            .carrusel-control.prev {
                left: 2%;
            }

            .carrusel-control.next {
                right: 2%;
            }

            .carrusel-control:hover {
                background: rgba(0, 0, 0, 0.8);
                color: #aaaaaa;
            }

        #carrusel-1:checked ~ .control-1,
        #carrusel-2:checked ~ .control-2,
        #carrusel-3:checked ~ .control-3 {
            display: block;
        }

        .carrusel-indicators {
            list-style: none;
            margin: 0;
            padding: 0;
            position: absolute;
            bottom: 2%;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 10;
        }

            .carrusel-indicators li {
                display: inline-block;
                margin: 0 5px;
            }

        .carrusel-bullet {
            color: #fff;
            cursor: pointer;
            display: block;
            font-size: 35px;
        }

            .carrusel-bullet:hover {
                color: #aaaaaa;
            }

        #carrusel-1:checked ~ .control-1 ~ .carrusel-indicators li:nth-child(1) .carrusel-bullet,
        #carrusel-2:checked ~ .control-2 ~ .carrusel-indicators li:nth-child(2) .carrusel-bullet,
        #carrusel-3:checked ~ .control-3 ~ .carrusel-indicators li:nth-child(3) .carrusel-bullet {
            color: #428bca;
        }

        .carrusel-item img {
            height: auto
        }

        .carrusel-item {
            display: grid;
            grid-template-columns: auto auto auto;
            height: 350px
        }
        .interno{display:flex}
        .form-control{max-width:100%}
        .modal-content.index{
            width:70%;
            margin:0 auto
        }
        .index-form>div{padding:0}
    </style>


</head>
<div>
    <div style="margin-left: 2%;">
        <h4 style="display:none">
            @Html.ActionLink("Hello " + User.Identity.GetUserName() + "!", "Manage", "Account", new { idUser = User.Identity.GetUserId() }, htmlAttributes: new { title = "Manage" })
        </h4>
    </div>
    <br />
    <div class="grid-container" id="grid-container">
        <div class="grid-item" id="row1" style="">
            <div id="news">
                <div id="add-dates">
                    <h4><b style="color: #21356a">Noticias</b></h4>
                    <span style="font-size: 3em; color: #21356a; float: right;" data-toggle="modal" data-target="#myModal">
                   <img src="~/UploadedFiles/Intranet_Noticias.png" width="50px"/>
                    </span>
                </div>
                <table style="margin-left:5%; width: 90%">
                    @foreach (var field in ViewBag.news)
                    {
                        <tr>
                            <th style="font-size: medium; background: #CCC7C7; color: #122143">- @field.Title</th>
                            <th style="font-size: medium; background: #CCC7C7; color: #122143"></th>
                        </tr>
                        <tr>
                            <td style="font-size:small; color:#7F7B7B">@field.Description</td>
                            <td style="font-size:small; color:#7F7B7B"><a href="@field.IdNotice" style="color: blue" class="newDetails">Ver Detalles</a></td>
                        </tr>
                    }
                </table>
            </div>
            <div class="container" id="">
                <!-- Modal -->
                <div class="modal fade" id="myModal" role="dialog">
                    <div class="modal-dialog" style="">
                        <!-- Modal content-->
                        <div class="modal-content index">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title">Nueva Noticia</h4>
                            </div>
                            <!--form New Notice-->
                            <form method="post" action="/Home/SaveNotice">
                                <div class="modal-body">
                                    <p>Detalles</p>
                                    <div id="validation"></div>
                                    <hr />
                                    <!--title-->
                                    <input class="form-control" type="text" placeholder="Titulo" name="title" id="title">
                                    <br />
                                    <div class="form-group row interno">
                                        <label for="typeNotice" class="col-sm-4 col-form-label">Tipo de Noticia</label>
                                        <br />
                                        <!--checkBoxes-->
                                        <div class="col-sm-8">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" value="" id="oneDateChecked">
                                                <label class="form-check-label" for="defaultCheck1">
                                                    Un Solo dia.
                                                </label>
                                            </div>
                                        </div>
                                        </div>
                                    <div class="index-form">
                                        <!--calendar startDate-->
                                        <div class='col-sm-12'>
                                            <div class="form-group">
                                                <input type='text' class="form-control" placeholder="Fecha de Inicio" name="startDateNews" id="startDateNews" />
                                            </div>
                                        </div>
                                        <!--calendar endDate-->
                                        <div class='col-sm-12'>
                                            <div class="form-group">
                                                <input type='text' class="form-control" placeholder="Fecha de Fin" name="endDateNews" id="endDateNews" />
                                            </div>
                                        </div>
                                        <!--description-->
                                        <div class='col-sm-12'>
                                            <div class="form-group">
                                                <label for="exampleFormControlTextarea1">Descripción</label>
                                                <textarea class="form-control" id="description" rows="6" style="resize: none" name="description"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <!--save notice-->
                                    <div style="text-align:center">
                                        <input type="submit" class="btn btn-default" value="Guardar" id="btnSaveNotice" />
                                        <!--<button type="button" class="btn btn-default" data-dismiss="modal" id="btnClose">Cerrar</button>-->
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container" id="">
                <!-- Modal -->
                <div class="modal fade" id="myModal2" role="dialog">
                    <div class="modal-dialog" style="height: 90%">
                        <!-- Modal content-->
                        <div class="modal-details">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title">Detalles de la Noticia</h4>
                            </div>
                            <div class="modal-body">
                                <div class="form-group row">
                                    <label for="titleNotice" class="col-sm-2 col-form-label" style="color: darkblue">Titulo: </label>
                                    <div class="col-sm-10">
                                        <label for="titleNotice" class=" " id="titleNotice"></label>
                                    </div>
                                    <br />
                                    <label for="descriptionNotice" class="col-sm-2 col-form-label" style="color: darkblue">Descripción: </label>
                                    <div class="col-sm-10">
                                        <label for="titleNotice" class="" id="descriptionNotice"></label>
                                    </div>
                                    <hr />
                                    <label for="startNotice" class="col-sm-2 col-form-label" style="color: darkblue">Fecha de Inicio: </label>
                                    <div class="col-sm-10">
                                        <label for="startNotice" class="col-sm-4 col-form-label" id="startNotice"></label>
                                        <label for="startNotice" class="col-sm-4 col-form-label" style="color: darkblue">Fecha de Termino: </label>
                                        <label for="startNotice" class="col-sm-4 col-form-label" id="endNotice"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="grid-item" id="row2">
            <div id="events" style="height: 100%;">
                <div class="" id="calendar" style=""></div>
            </div>
            <br /><br />
        </div>
    </div>
    <!--<div class="grid-item" id="row3">
        <div class="container" id="gallery" style="border: 1.5px solid orange;">
            @Html.ActionLink("Galeria", "Index", "Gallery", null, new { style = "color: white" })<br />
            @Html.ActionLink("Example", "Parent", "Home", null, new { style = "color: white" })<br />
            @Html.ActionLink("Chat", "Chat", "Home", null, new { style = "color: white" })
        </div>
    </div>-->
    <!--Carousel Images-->
    <div>
        <div class="carrusel">
            <div class="carrusel-inner">
                <input class="carrusel-open" type="radio" id="carrusel-1" name="carrusel" aria-hidden="true" hidden="" checked="checked">
                <div class="carrusel-item">
                    <img src="~/UploadedFiles/asd2.jpg">
                    <img src="~/UploadedFiles/asd3.jpg">
                    <img src="~/UploadedFiles/asd2.jpg">
                </div>
                <input class="carrusel-open" type="radio" id="carrusel-2" name="carrusel" aria-hidden="true" hidden="">
                <div class="carrusel-item">

                    <img src="~/UploadedFiles/asd2.jpg">
                    <img src="~/UploadedFiles/asd3.jpg">
                    <img src="~/UploadedFiles/asd2.jpg">
                </div>
                <input class="carrusel-open" type="radio" id="carrusel-3" name="carrusel" aria-hidden="true" hidden="">
                <div class="carrusel-item">
                    <img src="~/UploadedFiles/asd2.jpg">
                    <img src="~/UploadedFiles/asd3.jpg">
                    <img src="~/UploadedFiles/asd2.jpg">
                </div>
                <label for="carrusel-3" class="carrusel-control prev control-1">‹</label>
                <label for="carrusel-2" class="carrusel-control next control-1">›</label>
                <label for="carrusel-1" class="carrusel-control prev control-2">‹</label>
                <label for="carrusel-3" class="carrusel-control next control-2">›</label>
                <label for="carrusel-2" class="carrusel-control prev control-3">‹</label>
                <label for="carrusel-1" class="carrusel-control next control-3">›</label>
                <ol class="carrusel-indicators">
                    <li>
                        <label for="carrusel-1" class="carrusel-bullet">•</label>
                    </li>
                    <li>
                        <label for="carrusel-2" class="carrusel-bullet">•</label>
                    </li>
                    <li>
                        <label for="carrusel-3" class="carrusel-bullet">•</label>
                    </li>
                </ol>
            </div>
        </div>
    </div>
</div>
<!--JS Calendar-->
<script>
    document.addEventListener('DOMContentLoaded', function () {

        var calendarEl = document.getElementById('calendar');
        //console.log("Entra a Cargar Calendar");

        var notices = "@ViewBag.news2";
        //console.log(notices);
        let json = JSON.parse(notices.replace(/&quot;/g, '"'));
        //console.log(json);
        //console.log(json[0]['startDateNotice']);

        //Parse Json Dates start and end notice
        for (let key in json) {

            let date = json[key].StartDateNotice;
            let date2 = json[key].EndDateNotice;
            date = date.substring(0, date.length - 14);
            date2 = date2.substring(0, date2.length - 14);
            date = date.match(/\d+/g);
            date2 = date2.match(/\d+/g);
            date = date[2] + "-" + date[1] + "-" + date[0];
            date2 = date2[2] + "-" + date2[1] + "-" + date2[0];

            //date2 = date2.substring(6, date2.length - 4);
            //let startDate = new Date(date).toISOString().slice(0, 10).replace('T', ' ');
            //console.log(date);
            //console.log(date2);

            json[key].StartDateNotice = date;
            json[key].EndDateNotice = date2;

        }

        //console.log(json);
        let noticeObj = [];

        for (let key in json) {

            let str = {};
            let id;
            let title;
            let start;
            let end;

            id = json[key].IdNotice;
            title = json[key].Title;
            start = json[key].StartDateNotice;
            end = json[key].EndDateNotice;

            if (start == end) {
                //console.log(title);
                //console.log("fechas iguales");
                str.id = id.toString();
                //str.resourceId = 'a',
                str.title = title;
                str.start = start;
                //str.url = 'http://google.com/';
                noticeObj.push(str);

            } else {
                str.id = id.toString();
                str.title = title;
                str.start = start;
                str.end = end;

                noticeObj.push(str);
            }
        }

        //console.log(noticeObj);
        var calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: ['interaction', 'dayGrid'],
            header: {
                left: 'prevYear,prev,next,nextYear today',
                center: 'title',
                right: 'dayGridMonth,dayGridWeek,dayGridDay'
            },
            //defaultDate: '2019-03-12',
            navLinks: true, // can click day/week names to navigate views
            editable: false,
            eventLimit: false, // allow "more" link when too many events

            events: noticeObj,


            eventClick: function (event, jsEvent, view) {
                //console.log(event.id);
                //console.log(event.title);
            }






        });
        calendar.render();
        calendar.setOption('locale', 'es');
        calendar.on('dateClick', function (info) {
            console.log('clicked on ' + info.dateStr);

        });

    });
</script>
<!--Functions and eventlisteners-->
<script type="text/javascript">

    $('#title').on('focus', function (e) {
        $(this).attr("autocomplete", "off");
    });

    $('#oneDateChecked').change(function () {

        if (($('#startDateNews').val() != "") || ($('#endDateNews').val() != "")) {
            //$('#startDateNews').val('');
            $('#endDateNews').val('');
        }

        if ($(this).prop('checked')) {
            $('#endDateNews').prop('disabled', true);
        } else {
            $('#endDateNews').prop('disabled', false);
        }
    });

    $('#btnClose').click(function (e) {
        $modal = $('#myModal');
        $modal.find('form')[0].reset();

        $("p").remove();

    });

    $('#btnSaveNotice').click(function (e) {
        // console.log("entra save notice");
        e.preventDefault();

        if ($('#msgValidate').length) {
            $("p").remove();
        }

        let title = $('#title').val();
        let description = $('#description').val();
        let startDateNews = $('#startDateNews').val();
        let endDateNews = $('#endDateNews').val();
        let isEvent = false;

        //checked just oney day
        if ($('#oneDateChecked').is(":checked")) {

            validateControl(title, description, startDateNews);

            //console.log("entra is checked");
            //dateNow
            let dateNow = Date(Date.now());
            //console.log("Today: " + dateNow.toString());
            //dateSelect
            let startDate = $j("#startDateNews").val();
            //console.log("day select: " + startDate);
            let dateSelect = new Date(startDate).toISOString().slice(0, 19).replace('T', ' ');
            //console.log("day select: " + dateSelect);

            if (Date.parse(dateSelect) < Date.parse(dateNow)) {
                //alert("Seleccionaste un dia no valido   ");
                $('#validation').append("<p id='msgValidate' style='color: red; font-size: 15px'>La fecha no puede ser menor a la actual</p>");

                return;
            }

            console.log("Listo para enviar");
            console.log("title: " + title);
            console.log("description: " + description);
            console.log("dateSelect: " + dateSelect);

            let notice = {
                title: title,
                description: description,
                startDate: dateSelect,
                endDate: dateSelect,
                fileName: "",
                path: "",
                isEvent: isEvent
            };

            saveNotice(notice);

        } else {
            //validations
            validateControl(title, description, startDateNews, endDateNews);

            //dateNow
            let dateNow = Date(Date.now());
            console.log("Today: " + dateNow.toString());
            //dateStartDate
            let startDate = $j("#startDateNews").val();
            let dateSelect1 = new Date(startDate).toISOString().slice(0, 19).replace('T', ' ');
            console.log("day startDate: " + dateSelect1);
            //dateEndDate
            let endDate = $j("#endDateNews").val();
            console.log("endDateNews: " + endDate);
            let dateSelect2 = new Date(endDate).toISOString().slice(0, 19).replace('T', ' ');
            console.log("day endDate: " + dateSelect2);
            let isEvent = false;

            if (Date.parse(dateSelect1) < Date.parse(dateNow)) {
                //alert("Seleccionaste un dia no valido   ");
                $('#validation').append("<p id='msgValidate' style='color: red; font-size: 15px'>La fecha inicial no puede ser menor a la actual</p>");

                return;
            }

            if ((Date.parse(dateSelect2) < Date.parse(dateSelect1)) || (Date.parse(dateSelect2) == Date.parse(dateSelect1))) {
                //alert("Seleccionaste un dia no valido   ");
                $('#validation').append("<p id='msgValidate' style='color: red; font-size: 15px'>La fecha final no puede ser menor a la inicial</p>");

                return;
            }

            console.log("Listo para enviar");
            console.log("title: " + title);
            console.log("description: " + description);
            console.log("dateSelect1: " + dateSelect1);
            console.log("dateSelect2: " + dateSelect2);

            let notice = {
                title: title,
                description: description,
                startDate: dateSelect1,
                endDate: dateSelect2,
                isEvent: isEvent
            };

            saveNotice(notice);
        }


    });

    $('.newDetails').click(function (e) {
        e.preventDefault();

        let idNew = $(this).attr('href');
        //console.log(idNew);
        //alert(idNew);

        getNotice(idNew);

    });

    function validateControl(...restArgs) {
        //console.log(restArgs.length);
        let blank = 0;

        for (let i = 0; i < restArgs.length; i++) {
            //validate blank fields
            blank = validateBlank(restArgs[i]);
        }

        if (blank === 1) {
            $('#validation').append("<p id='msgValidate' style='color: red; font-size: 15px'>El formulario no debe tener campos vacios</p>");

            return;
        }
    }

    function validateBlank(...restArgs) {
        for (let i = 0; i < restArgs.length; i++) {
            //console.log(restArgs[i].toString());
            if (restArgs[i] === '') {
                return 1;
            }
        }
    }

    function saveNotice(notice) {
        console.log("entra a guardar");
        console.log(notice);

        console.log("####################");

        $.ajax({
            url: 'SaveNotice',
            dataType: "json",
            type: "POST",
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify({ notice: { title: notice['title'], description: notice['description'], startDateNotice: notice['startDate'], endDateNotice: notice['endDate'], fileName: notice['fileName'], path: notice['path'], isEvent: notice['isEvent'] } }),
            //data: JSON.stringify(notice),
            async: true,
            processData: false,
            cache: false,
            success: function (data) {
                if (data === 'successfully') {
                    console.log("Noticia creada");


                    $modal = $('#myModal');
                    $modal.find('form')[0].reset();
                    $('#myModal').modal('hide');
                    location.reload();
                }
            },
            error: function (xhr) {
                alert('error');
            }
        })

    }

    function getNotice(idNotice) {
        console.log('Entra a consultar noticia');
        console.log(idNotice);

        $.ajax({
            url: 'getNotice/?idNotice=' + idNotice,
            dataType: 'json',
            type: 'GET',
            contentType: 'application/json; charset=utf-8',
            async: true,
            processData: false,
            cache: false,
            success: function (data) {

                console.log(data);
                let title = data['Title'];
                let description = data['Description'];
                let date = data['StartDateNotice'];
                let date2 = data['EndDateNotice'];
                date = date.substring(0, date.length - 14);
                date2 = date2.substring(0, date2.length - 14);
                /*date = date.substring(6, date.length - 2);
                date2 = date2.substring(6, date2.length - 2);
                date = Number(date);
                date2 = Number(date2);*/

                //let startDate = new Date(date).toISOString().slice(0, 10).replace('T', ' ');
                //let endtDate = new Date(date2).toISOString().slice(0, 10).replace('T', ' ');

                $('#myModal2').modal('show');
                $('#titleNotice').text(title);
                $('#descriptionNotice').text(description);
                $('#startNotice').text(date);
                $('#endNotice').text(date2);



            },
            error: function (e) {
                //console.log(e);
            }
        });
    }

    /*----------------------Change JQuery Version----------------------*/
    $j = jQuery.noConflict();

    $j(function () {
        $j('#datetimepicker1').datetimepicker();
    });

    $j("#datetimepicker1").on("dp.change", function (e) {

        $j("#datetimepicker1").hide();
        $j("#datetimepicker1").show();
    });

    $j(function () {
        $j('#startDateNews').datetimepicker({
            showClose: true,
            showClear: true,
            format: 'YYYY-MM-DD',

            tooltips: {
                selecTime: 'Selecciona la hora',
                clear: 'Limpiar Selección',
                close: 'Cerrar Ventana',

            }

        });
    });

    $j(function () {
        $j('#endDateNews').datetimepicker({
            showClose: true,
            showClear: true,
            format: 'YYYY-MM-DD',

            tooltips: {
                selecTime: 'Selecciona la hora',
                clear: 'Limpiar Selección',
                close: 'Cerrar Ventana',

            }
        });
    });

    $j("#startDateNews").on("dp.change", function (e) {

        $j('#endDateNews').data("DateTimePicker").minDate(e.date);
        $(this).attr("autocomplete", "off");

    });

    $j("#endDateNews").on("dp.change", function (e) {

        $j('#startDateNews').data("DateTimePicker").maxDate(e.date);
        $(this).attr("autocomplete", "off");
    });

</script>



